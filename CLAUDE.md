# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Spatio-temporal Bayesian modelling pipeline for malaria incidence in Rwanda at the sector (ADM3) level, using R-INLA. The entire analysis lives in a single R script: `Malaria_Kigali_ Model.R`.

## Running

This is an R script meant to be run interactively (e.g., in RStudio). Source the whole file or run sections sequentially:

```r
source("Malaria_Kigali_ Model.R")
```

Packages are loaded via `pacman::p_load()`. Key dependencies: `INLA`, `sf`, `spdep`, `dplyr`, `tidyr`, `ggplot2`, `readxl`, `corrplot`, `usdm`, `viridis`, `patchwork`.

**Note:** INLA is not on CRAN. Install with:
```r
install.packages("INLA", repos = c(getOption("repos"), INLA = "https://inla.r-inla-download.org/R/stable"))
```

## Required Input Files (not in repo)

- `shapefile/rwa_adm3_2006_NISR_WGS1984_20181002.shp` — Rwanda ADM3 sector polygons
- `U_5_diarrhea_climate.xlsx` — Under-5 population, diarrhoea cases, climate covariates by sector/month
- `malaria_modelling_Oslo.xlsx` — Monthly malaria case counts by sector

These must be placed in the working directory before running.

## Pipeline Structure (sequential sections in the script)

1. **Setup** (§1): Package loading, file paths
2. **Spatial data** (§2): Load shapefile, fix sector name mismatches, build adjacency graph (`Adj_Map.graph`) for INLA via `poly2nb` / `nb2INLA`
3. **Data ingestion** (§3): Read Excel files for U5 and malaria data
4. **Cleaning & imputation** (§4-5): Median imputation for missing values, standardize join keys (lowercase, trimmed)
5. **Merge & spatial join** (§6): Left-join U5 + malaria on (district, sector, Year, Month), then merge with shapefile geometry
6. **Modelling dataset** (§7): Create time/space/space-time indices (`ID`, `ID.time`, `ID.space.time`), rename climate columns, create 1- and 2-month lagged climate covariates, VIF/correlation diagnostics
7. **Model specification** (§8): ~15 INLA formula variants — spatial-only (IID, Besag, BYM, BYM2), temporal-only (RW1, RW2), spatio-temporal (BYM+RW1+IID interaction, Type I–IV interactions), with/without climate covariates and lags
8. **Model fitting** (§9): All models fitted via `inla()` with Poisson family, log-population offset, DIC/WAIC/CPO computed
9. **Model comparison**: `compare_inla_models()` function ranks models by WAIC/DIC/mean-log-CPO and prints a table, but there is **no automatic selection** — the analyst reviews the table and the final model is hardcoded
10. **Final model**: Manually chosen as BYM + RW1 + IID space-time interaction + 8 standardized lagged climate covariates (`formula_final_bym`)
11. **Post-processing**: Spatial RR maps, temporal RR trends, exceedance probabilities P(RR > 1), space-time interaction effects
12. **Forecasting**: 3-month-ahead predictions using INLA's missing-data trick (set future `Malaria_Cases = NA`), with climate persistence assumption
13. **Visualization**: National and district-level time series (historical + forecast), faceted maps by year, Bugesera district detail plots

## Key Variables and Conventions

- `dat` — main modelling `sf` data frame after all joins and feature engineering
- `ID` = `Sec_ID` — unique sector identifier (row number in shapefile)
- `ID.time` — monthly time index (1 to 120 for 10 years × 12 months)
- `ID.space.time` — row-level index for the IID space-time interaction
- `offset_pop` = `log(Population / 1000)` — Poisson offset
- Climate covariates: `Max_temperature`, `Min_temperature`, `Prec` (precipitation), `Relative_humidity`; lag suffixes `_lag1`, `_lag2`
- Air temperature dropped due to high collinearity with max temperature
- Sector name fixes: Mageregere→Mageragere, Shyrongi→Shyorongi, Ririma→Rilima

## Output Files (generated by the script)

- `Adj_Map.graph` — INLA adjacency graph
- `post_spatial_RR_PP.rds`, `post_spatial_RR_PP_sf.rds`, `post_temporal_RR.rds`, `post_spacetime_RR.rds` — posterior summaries
- `forecast_malaria_next_3_months.rds` — 3-month forecast
- `PP_yearly_facets.png` — yearly exceedance probability maps
